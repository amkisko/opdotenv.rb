#!/usr/bin/env ruby

# Run appraisal tests locally
# Usage:
#   bin/appraisals                          # Run tests for all appraisals
#   bin/appraisals rails-6.0                 # Run tests for a specific appraisal
#   bin/appraisals rails-6.0 rails-7.0       # Run tests for multiple appraisals
#   bin/appraisals rails-6.0 rspec -fd      # Run rspec with flags for an appraisal
#   bin/appraisals rails-6.0 rake spec      # Run rake spec for an appraisal

require "bundler/setup"

APP_ROOT = File.dirname(File.dirname(File.expand_path(__FILE__)))
APPRAISALS_FILE = File.join(APP_ROOT, "Appraisals")
GEMFILES_DIR = File.join(APP_ROOT, "gemfiles")

unless File.exist?(APPRAISALS_FILE)
  $stderr.puts "Error: Cannot find Appraisals file at #{APPRAISALS_FILE}"
  exit 1
end

AVAILABLE_APPRAISALS = File.read(APPRAISALS_FILE, encoding: "UTF-8")
  .scan(/appraise\s+"([^"]+)"/)
  .flatten
  .freeze

def usage
  puts <<~USAGE
    Usage: bin/appraisals [appraisal_name...] [command]

    Examples:
      bin/appraisals                            # Run rspec for all appraisals
      bin/appraisals rails-6.0                  # Run rspec for rails-6.0
      bin/appraisals rails-7.0                  # Run rspec for rails-7.0
      bin/appraisals rails-8.0                  # Run rspec for rails-8.0
      bin/appraisals rails-6.0 rspec -fd        # Run rspec with flags

    Available appraisals: #{AVAILABLE_APPRAISALS.join(', ')}
  USAGE
  exit 1
end

def parse_args
  args = ARGV.dup

  if args.include?("--help") || args.include?("-h")
    usage
  end

  return [AVAILABLE_APPRAISALS, ["rspec"]] if args.empty?

  appraisals = []
  command = []

  args.each do |arg|
    if AVAILABLE_APPRAISALS.include?(arg)
      appraisals << arg
    else
      command << arg
    end
  end

  appraisals = AVAILABLE_APPRAISALS if appraisals.empty?
  command = ["rspec"] if command.empty?

  [appraisals, command]
end

def ensure_gemfiles_exist
  # Check if any gemfiles are missing
  missing = AVAILABLE_APPRAISALS.select do |appraisal|
    gemfile_name = appraisal.gsub("-", "_") + ".gemfile"
    gemfile_path = File.join(GEMFILES_DIR, gemfile_name)
    !File.exist?(gemfile_path)
  end

  return if missing.empty?

  puts "Generating missing gemfiles for: #{missing.join(', ')}..."
  Dir.chdir(APP_ROOT) do
    missing.each do |appraisal|
      unless system("bundle exec appraisal generate #{appraisal}")
        puts "✗ ERROR: Failed to generate gemfile for #{appraisal}"
        return false
      end
    end
  end
  true
end

def ensure_platform_compatibility(gemfile_path)
  lockfile_path = gemfile_path + ".lock"
  return unless File.exist?(lockfile_path)

  # Check if x86_64-linux platform is already in the lockfile
  lockfile_content = File.read(lockfile_path)
  return if lockfile_content.include?("x86_64-linux")

  # Add Linux platform for CI compatibility
  puts "Adding x86_64-linux platform to #{File.basename(lockfile_path)}..."
  Dir.chdir(APP_ROOT) do
    system("bundle lock --add-platform x86_64-linux --gemfile #{gemfile_path}") || true
  end
end

def run_appraisal(appraisal, command)
  puts "\n" + "=" * 80
  puts "Running #{appraisal} with: #{command.join(' ')}"
  puts "=" * 80

  # Ensure all gemfiles exist
  unless ensure_gemfiles_exist
    puts "✗ ERROR: Failed to generate required gemfiles"
    return false
  end

  # Appraisal converts hyphens to underscores in gemfile names
  gemfile_name = appraisal.gsub("-", "_") + ".gemfile"
  gemfile_path = File.join(GEMFILES_DIR, gemfile_name)
  
  unless File.exist?(gemfile_path)
    puts "✗ ERROR: Gemfile for #{appraisal} not found at #{gemfile_path}"
    return false
  end

  # Ensure platform compatibility for CI
  ensure_platform_compatibility(gemfile_path)

  # Install gems for this specific gemfile
  puts "Installing gems for #{appraisal}..."
  Dir.chdir(APP_ROOT) do
    unless system("bundle install --gemfile #{gemfile_path}")
      puts "✗ ERROR: Failed to install gems for #{appraisal}"
      return false
    end
  end

  # Run the command with the appraisal gemfile
  Dir.chdir(APP_ROOT) do
    run_cmd = ["bundle", "exec", "appraisal", appraisal] + command
    system(*run_cmd)
  end
end

appraisals, command = parse_args

unless appraisals.all? { |a| AVAILABLE_APPRAISALS.include?(a) }
  puts "Error: Invalid appraisal(s)"
  usage
end

results = {}
appraisals.each do |appraisal|
  results[appraisal] = run_appraisal(appraisal, command)
end

puts "\n" + "=" * 80
puts "Summary"
puts "=" * 80
appraisals.each do |appraisal|
  status = results[appraisal] ? "✓ PASSED" : "✗ FAILED"
  puts "#{appraisal}: #{status}"
end

exit 0 if results.values.all?
exit 1


