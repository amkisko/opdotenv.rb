#!/usr/bin/env ruby
# frozen_string_literal: true

$LOAD_PATH.unshift(File.expand_path("../lib", __dir__))
require "opdotenv"
require "optparse"

cmd = ARGV.shift

case cmd
when "read"
  path = nil
  OptionParser.new do |o|
    o.on("--path PATH", "op://Vault/Item") { |v| path = v }
  end.parse!(ARGV)
  abort("--path required") unless path
  data = Opdotenv::Loader.load(path)
  # Note: This CLI intentionally outputs secrets to stdout for CLI usage
  # This is expected behavior for the command-line tool
  puts Opdotenv::Exporter.serialize_by_format(data, :dotenv)
when "export"
  path = file = nil
  field_type = nil
  OptionParser.new do |o|
    o.on("--path PATH", "op://Vault/Item") { |v| path = v }
    o.on("--file PATH", "Source file (.env/json/yaml)") { |v| file = v }
    o.on("--field-type TYPE", [:dotenv, :json, :yaml, :yml], "Override format (default: inferred from path)") { |v| field_type = v }
  end.parse!(ARGV)
  abort("--path and --file required") unless path && file
  # Infer format from file extension if not provided
  field_type ||= infer_format_from_file(file)
  text = File.read(file)
  data = Opdotenv::Loader.parse_by_format(text, field_type)
  Opdotenv::Exporter.export(path: path, data: data, field_type: field_type)
else
  warn "Usage: opdotenv (read|export) ..."
  exit 1
end

def infer_format_from_file(file)
  case File.extname(file)
  when ".json" then :json
  when ".yaml", ".yml" then :yaml
  else :dotenv
  end
end
